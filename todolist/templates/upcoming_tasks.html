{% extends "base.html" %} {% block content %}
<main>
    <div style="margin-top: 8em">
        <h1 style="text-align: center">Upcoming Tasks</h1>
        <a href="/tasks/today" class="btn btn-primary">Today's Tasks</a>
        <a
            class="btn btn-primary"
            data-toggle="modal"
            data-target="#AddTaskModal"
            >Add Task</a
        >
        {% for key, val in tasks.items() %}
        <h1 style="text-align: center">{{ key.strftime("%m.%d.%Y") }}</h1>
        <div class="cards" id="tasks">
            {% for item in val %}
            <div class="card text-center" style="width: 18rem">
                <div class="card-body">
                    <h5 class="card-title">
                        {{ item.title }} - {% if item.done %} Done! {% else %}
                        In progress {% endif %}
                    </h5>
                    <p class="card-text">Priority: {{ item.priority }}</p>
                    <div class="card_buttons">
                        <input type="checkbox" id="completed" name="{{ item.id }}" onclick="completeTask(this.name)">
                        <a href="/tasks/{{ item.id }}" class="btn btn-info"
                            >Edit</a
                        >
                        <a
                            href="/tasks_delete/{{ item.id }}"
                            class="btn btn-danger"
                            >Delete</a
                        >
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endfor %}
    </div>
</main>
{% endblock %} {% block script %}
<script>
    // Создаем HTML pattern для элемента, который будет отображаться
    function createTaskPattern(data) {
        var pattern = [
            '<div class="card text-center" style="width: 18rem">',
            '<div class="card-body">',
            '<h5 class="card-title">',
            data["title"],
            "</h5>",
            '<p class="card-text">Priority:',
            data["priority"],
            "</p>",
            '<div class="card_buttons">',
            '<input type="checkbox" id="completed" name="',
            data["id"],
            '" onclick="completeTask(this.name)">',
            '<a href="/tasks/',
            data["id"],
            '" class="btn btn-info">Edit</a>',
            '<a href="/tasks_delete/',
            data["id"],
            '" class="btn btn-danger">Delete</a>',
            "</div>",
            "</div>",
            "</div>",
        ];

        return pattern.join("");
    }

    // Search Implementation
    // Отправляем HTTP запрос в python функцию
    // и получаем оттуда информацию из базы данных
    // В теле запроса передаем содержимое поисковой строки
    function fetchData(text, url) {
        const tasks = document.querySelector("#tasks");

        fetch(url, {
            method: "POST",
            body: JSON.stringify(text),
            headers: {
                "Content-Type": "application/json",
            },
        })
            .then(function (response) {
                if (!response.ok) {
                    throw Error(response.statusText);
                }

                response.json().then(function (data) {
                    let pattern,
                        nodes = "";

                    data.forEach((element) => {
                        pattern = createTaskPattern(element);
                        nodes += pattern;
                    });

                    tasks.innerHTML = nodes;
                });
            })
            .catch(function (error) {
                tasks.innerHTML = "Failed to load";
            });
    }

    // При вводе в поисковое поле вызываем функцию fetchSearch
    document.getElementById("finder").oninput = function () {
        const textToFind = this.value.trim();

        fetchData(textToFind, '{{ url_for("tasks.search_request") }}');
    };

    // Task completion implementation
    // id передается при нажатии на конкретный checkbox
    function completeTask(id) {
        const checkbox = document.getElementsByName(id)[0].checked;

        // Проверяем если checkbox активен
        if (checkbox) {
            fetchData(id, '{{ url_for("tasks.complete_task") }}');
        }
    }
</script>
{% endblock script %}
