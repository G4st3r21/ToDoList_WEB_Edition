{% extends "base.html" %} {% block content %}
<main>
    <div class="container" id="cards" style="margin-top: 8em">
        <div class="card_header">
            <h1 style="text-align: center">Today Tasks</h1>
            <div class="btn-group">
                <a
                    href="{{ url_for('users.upcoming_tasks') }}"
                    class="btn btn-primary"
                    >All tasks</a
                >
            </div>
            <button
                class="btn btn-primary"
                data-toggle="modal"
                data-target="#AddTaskModal"
                >Add Task</button
            >
        </div>
        <div class="cards" id="tasks">
            {% for item in tasks %}
            <div class="card text-center" style="width: 18rem">
                <div class="card-body">
                    <h5 class="card-title">{{ item.title }}</h5>
                    <p class="card-text">
                        Priority: <span class="priority">{{ item.priority }}</span>
                    </p>
                    <div class="btn-group" style="width: 250px; height: 43px;">
                        <button
                            type="button"
                            class="btn btn-primary"
                            data-toggle="button"
                            autocomplete="off"
                            onclick="completeTask('{{ item.id }}')"
                        >
                            Done
                        </button>
                        <button class="btn btn-info" onclick=location.href="{{ url_for('tasks.edit_task', task_id=item.id) }}">Edit</button>
                        <button class="btn btn-danger" onclick=location.href="{{ url_for('tasks.delete_task', task_id=item.id) }}">Delete</button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</main>

<div class="modal" id="AddTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Task</h5>
                <button
                    type="button"
                    class="close"
                    data-dismiss="modal"
                    aria-label="Close"
                >
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form action="" method="post">
                    {{ form.hidden_tag() }}
                    <p>
                        {{ form.title.label }}<br>
                        {{ form.title(class="form-control") }}<br>
                        {% for error in form.title.errors %}
                            <p class="alert alert-danger" role="alert">
                                {{ error }}
                            </p>
                        {% endfor %}
                    </p>
                    <p>
                        {{ form.priority.label }}<br>
                        {{ form.priority(class="form-control") }}<br>
                        {% for error in form.priority.errors %}
                            <p class="alert alert-danger" role="alert">
                                {{ error }}
                            </p>
                        {% endfor %}
                    </p>
                    <p>
                        {{ form.scheduled_date.label }}<br>
                        {{ form.scheduled_date(class="form-control") }}<br>
                        {% for error in form.scheduled_date.errors %}
                            <p class="alert alert-danger" role="alert">
                                {{ error }}
                            </p>
                        {% endfor %}
                    </p>
                    <p style="float: right;">{{ form.submit(type="submit", class="btn btn-primary") }}</p>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock content %} 
{% block script %}
<script>
    // Закрашивание карточек в соответсвии с приоритетностью
    let cardsColors = {1: "#f16a6a", 2: "#f5f25d", 3: "#5dd2f5", 4: "#6af55d"}
    
    function PriorityColor() {
        let priorities = document.querySelectorAll(".priority");
        let cards = document.querySelectorAll(".card");

        for (let i = 0; i < priorities.length; i++) {
            let priority = Number(priorities[i].innerHTML);

            cards[i].style.backgroundColor = cardsColors[priority];
        }
    }

    // Task completion implementation
    function completeTask(id) {
        fetchData(id, '{{ url_for("tasks.complete_task") }}');
    }


    // Создаем HTML pattern для элемента, который будет отображаться
    function createTaskPattern(data) {
        var pattern = [
            '<div class="card text-center" style="width: 18rem">',
            '<div class="card-body">',
            '<h5 class="card-title">',
            data["title"],
            '</h5>',
            '<p class="card-text">Priority: <span class="priority">',
            data["priority"],
            '</span></p>',
            '<div class="btn-group" style="width: 250px; height: 43px;">',
            '<button type="button" class="btn btn-primary" data-toggle="button" autocomplete="off" onclick=completeTask(',
            data["id"],
            ')>Done</button>',
            '<button class="btn btn-info" onclick=location.href="/tasks/',
            data["id"],
            '"> Edit </button>',
            '<button class="btn btn-danger" onclick=location.href="/tasks_delete/',
            data["id"],
            '">Delete</button>',
            "</div>",
            "</div>",
            "</div>",
        ];

        return pattern.join("");
    }

    // Search Implementation
    // Отправляем HTTP запрос в python функцию
    // и получаем оттуда информацию из базы данных
    // В теле запроса передаем содержимое поисковой строки
    function fetchData(text, url) {
        const tasks = document.querySelector("#tasks");

        fetch(url, {
            method: "POST",
            body: JSON.stringify(text),
            headers: {
                "Content-Type": "application/json",
            },
        })
            .then(function (response) {
                if (!response.ok) {
                    throw Error(response.statusText);
                }

                response.json().then(function (data) {
                    let pattern,
                        nodes = "";

                    data.forEach((element) => {
                        pattern = createTaskPattern(element);
                        nodes += pattern;
                    });

                    tasks.innerHTML = nodes;
                    PriorityColor();
                });
            })
            .catch(function (error) {
                tasks.innerHTML = `Failed to load. Reason: ${error.message}`;
            });
    }

    // При вводе в поисковое поле вызываем функцию fetchSearch
    document.getElementById("finder").oninput = function () {
        const textToFind = this.value.trim();

        // Поиск начнется только если в строке есть символы
        if (textToFind.match(/^[a-z0-9]*$/i)) {
            fetchData(textToFind, '{{ url_for("tasks.search_request") }}');
        }
    };

    document.addEventListener('DOMContentLoaded', function () {
        PriorityColor();
    }, false);
</script>
{% endblock script %}
